{% extends "base.html" %}

{% block title %}Student Dashboard - Student Management System{% endblock %}

{% block content %}
<div class="header">
    <h1>Student Dashboard</h1>
    <p>View your activities and submit assignments</p>
</div>

<div class="main-content">
    <!-- Quick Stats -->
    <div class="grid grid-3" style="margin-bottom: 2rem;">
        <div class="stat-card" style="border-color: #3b82f6;">
            <div class="stat-number" style="color: #3b82f6;">{{ activities|length }}</div>
            <div class="stat-label">Total Activities</div>
        </div>
        <div class="stat-card" style="border-color: #10b981;">
            <div class="stat-number" style="color: #10b981;">{{ submissions|length }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card" style="border-color: #f59e0b;">
            <div class="stat-number" style="color: #f59e0b;">{{ activities|length - submissions|length }}</div>
            <div class="stat-label">Pending</div>
        </div>
    </div>

    <!-- Activities -->
    <div class="card">
        <h3>üìö Your Activities</h3>
        {% if activities %}
            {% for activity in activities %}
            {% set submission = submissions.get(activity.id) %}
            <div class="activity-card {% if submission %}completed{% else %}pending{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0; color: #1f2937;">{{ activity.title }}</h4>
                            <div class="status-badge {% if submission %}status-completed{% else %}status-pending{% endif %}">
                                {% if submission %}
                                    ‚úÖ Submitted
                                {% else %}
                                    ‚è≥ Pending
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if activity.description %}
                        <p style="color: #6b7280; margin-bottom: 1rem;">{{ activity.description }}</p>
                        {% endif %}
                        
                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #9ca3af; margin-bottom: 1rem;">
                            <span>üë§ Assigned by: {{ activity.assigned_by_user.name }}</span>
                            {% if activity.due_date %}
                            <span>üìÖ Due: {{ activity.due_date }}</span>
                            {% endif %}
                            <span>üìÖ Created: {{ activity.created_at|datetime }}</span>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            {% if activity.resource_file %}
                            <a href="{{ url_for('download_file', filename=activity.resource_file) }}" 
                               class="btn btn-info" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                üìé Download Resources
                            </a>
                            {% endif %}
                            
                            {% if submission %}
                                <div class="btn btn-success" style="font-size: 0.875rem; padding: 0.5rem 1rem; cursor: default;">
                                    ‚úÖ Submitted on {{ submission.submitted_at|datetime }}
                                </div>
                                {% if submission.submitted_file %}
                                <a href="{{ url_for('download_file', filename=submission.submitted_file) }}" 
                                   class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                    üíæ View My Submission
                                </a>
                                {% endif %}
                            {% else %}
                                <button onclick="showSubmissionForm({{ activity.id }})" 
                                        class="btn" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                    üì§ Submit Assignment
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Submission Form (Hidden by default) -->
                {% if not submission %}
                <div id="submission-form-{{ activity.id }}" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                    <h5 style="margin-bottom: 1rem; color: #1f2937;">üì§ Submit Your Assignment</h5>
                    <form method="POST" action="{{ url_for('submit_activity', activity_id=activity.id) }}" 
                          enctype="multipart/form-data" onsubmit="return handleSubmission(event, {{ activity.id }})">
                        <div class="form-group">
                            <label for="submission_file_{{ activity.id }}">üìé Upload Your Work:</label>
                            <div class="file-upload-area">
                                <input type="file" id="submission_file_{{ activity.id }}" name="submission_file" 
                                       accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.xlsx,.zip,.png,.jpg,.jpeg,.gif"
                                       style="display: none;" required>
                                <div onclick="document.getElementById('submission_file_{{ activity.id }}').click();" style="cursor: pointer;">
                                    <p style="margin-bottom: 0.5rem;">üìÅ Click to select your file</p>
                                    <p style="font-size: 0.875rem; color: #6b7280;">Supported: PDF, DOC, TXT, Images, ZIP, etc.</p>
                                    <div class="file-info-{{ activity.id }}"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-success">
                                üöÄ Submit Assignment
                            </button>
                            <button type="button" onclick="hideSubmissionForm({{ activity.id }})" 
                                    class="btn btn-secondary">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                <h3 style="margin-bottom: 1rem;">No Activities Assigned Yet</h3>
                <p>Your instructor will assign activities here. Check back soon!</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function showSubmissionForm(activityId) {
    const form = document.getElementById(`submission-form-${activityId}`);
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth' });
}

function hideSubmissionForm(activityId) {
    const form = document.getElementById(`submission-form-${activityId}`);
    form.style.display = 'none';
}

function handleSubmission(event, activityId) {
    const fileInput = document.getElementById(`submission_file_${activityId}`);
    if (!fileInput.files.length) {
        alert('Please select a file to submit.');
        return false;
    }
    
    // Show loading state
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; display: inline-block; margin-right: 0.5rem;"></div>Submitting...';
    submitBtn.disabled = true;
    
    // Allow form submission to proceed
    return true;
}

// File input change handlers
document.addEventListener('DOMContentLoaded', function() {
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function(e) {
            const activityId = e.target.id.split('_').pop();
            const fileInfo = document.querySelector(`.file-info-${activityId}`);
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileInfo.innerHTML = `<p style="color: #10b981; margin-top: 0.5rem;"><strong>Selected:</strong> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</p>`;
            } else {
                fileInfo.innerHTML = '';
            }
        });
    });
});
</script>
{% endblock %}